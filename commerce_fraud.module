<?php

/**
 * @file
 * commerce_fraud main file.
 */

/**
 * Implements hook_menu().
 */
function commerce_fraud_menu() {
  $items['admin/commerce/config/fraud'] = array(
    'title' => 'Fraud Score Settings',
    'description' => 'Manage the penalties, thresholds, and caps for the Fraud Score.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('commerce_fraud_admin_settings'),
    'access arguments' => array('administer frauds'),
    'file' => '/includes/commerce_fraud.admin.inc',
  );

  if (module_exists('commerce_kickstart_menus')) {
    $items['admin/commerce/config/fraud']['parent'] = 'admin/commerce/config/advanced-settings';
  }

  return $items;
}

/**
 * Implements hook_commerce_order_status_info().
 */
function commerce_fraud_commerce_order_status_info() {
  $order_statuses = array();

  $order_statuses['fraudulent'] = array(
    'name' => 'fraudulent',
    'title' => t('Fraudulent'),
    'state' => 'canceled',
  );

  $order_statuses['high_risk'] = array(
    'name' => 'high_risk',
    'title' => t('High Risk'),
    'state' => 'pending',
  );

  return $order_statuses;
}

/**
 * Implements hook_permission().
 */
function commerce_fraud_permission() {
  return array(
    'administer frauds' => array(
      'title' => t('Administer Fraud Settings'),
      'description' => t('Allows users to configure the Commerce Fraud settings.'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Implements hook_help().
 */
function commerce_fraud_help($path) {
  switch ($path) {
    case 'admin/commerce/config/fraud':
      return '<p>' . t('This page lets you manage the Commerce Fraud settings.') . '</p>';
  }
}

/**
 * Implements hook_views_api().
 */
function commerce_fraud_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'commerce_fraud') . '/includes/views',
  );
}

/**
 * Callback for last order.
 */
function commerce_fraud_last_order($order, $minutes, $order_status = 'completed') {
  // Look for {users} orders created within {$time_elapsed} minutes
  $query = db_select('uc_orders', 'u')
    ->fields('u', array('order_id'))
    ->condition('uid', $order->uid)
    ->condition('order_status', $order_status)
    ->condition('created', time() - ($minutes * 60), '>=');

  return !empty($query->execute()->fetchAssoc());
}

/**
 * Returns a timestamp matching x days before today.
 */
function commerce_fraud_timestamp_from_minutes($minutes) {
  $date = new DateTimeImmutable();
  $date = $date->modify('- ' . $minutes . ' minutes');

  return $date->getTimestamp();
}

/**
 * Checks the street address for a PO Box.
 *
 * @param $order_wrapper
 * @return bool
 */
function commerce_fraud_order_has_pobox($order_wrapper) {
  $address = $order_wrapper->commerce_customer_shipping->commerce_customer_address->thoroughfare->value();

  return preg_match("/(p(.*)?o(.*?)?)(\s+)?(bo?x)?(\s+)?[#]?(\d+)?/i", $address);
}

/**
 * Returns the current fraud score for order id.
 *
 * @param $order_id
 *
 * @return int
 */
function commerce_fraud_get_fraud_score_for_order_id($order_id) {
  return db_select('commerce_fraud_fraud_score', 'f')
    ->fields('f', array('fraud_score'))
    ->condition('order_id', $order_id)
    ->execute()
    ->fetchField();
}

/**
 * Increases the fraud count of an order.
 *
 * @param stdClass $order
 *   The current commerce_order.
 * @param integer $counter
 *   By how much to increase the fraud count.
 */
function commerce_fraud_increase_fraud_count(stdClass $order, $counter) {
  $order_id = $order->order_id;
  $fraud_score = commerce_fraud_get_fraud_score_for_order_id($order_id);
  $fraud_score += $counter;
  commerce_fraud_write_record(array(
    'order_id' => $order_id,
    'fraud_score' => $fraud_score,
  ));
  rules_invoke_event('commerce_fraud_count_changed', $order);
}

/**
 * Decreases the fraud count of an order.
 *
 * @param stdClass $order
 *   The current commerce_order.
 * @param integer $counter
 *   By how much to increase the fraud count.
 */
function commerce_fraud_decrease_fraud_count(stdClass $order, $counter) {
  $order_id = $order->order_id;
  $fraud_score = commerce_fraud_get_fraud_score_for_order_id($order_id);
  $fraud_score -= $counter;
  commerce_fraud_write_record(array(
    'order_id' => $order_id,
    'fraud_score' => $fraud_score,
  ));
  rules_invoke_event('commerce_fraud_count_changed', $order);
}

/**
 * Reset the fraud count of an order.
 *
 * @param stdClass $order
 *   The current commerce_order.
 */
function commerce_fraud_reset_fraud_count(stdClass $order) {
  commerce_fraud_write_record(array(
    'order_id' => $order->order_id,
    'fraud_score' => 0,
  ));
  rules_invoke_event('commerce_fraud_count_changed', $order);
}

/**
 * Updates or inserts fraud_score for order id.
 *
 * @param array $record
 *   Must be an array with two keys: order_id and fraud_score
 */
function commerce_fraud_write_record(array $record) {
  db_merge('commerce_fraud_fraud_score')
    ->key(array('order_id' => $record['order_id']))
    ->fields($record)
    ->execute();
}


/**
 * Whitelist condition callback.
 */
function commerce_fraud_is_whitelisted($order) {
  if ($fraud_score = commerce_fraud_get_fraud_score_for_order_id($order->order_id)) {
    $whitelist_cap = variable_get('commerce_fraud_greylist_cap', 10);

    return $fraud_score < $whitelist_cap;
  }
  else {
    return TRUE;
  }
}

/**
 * Greylist condition callback.
 */
function commerce_fraud_is_greylisted($order) {
  if ($fraud_score = commerce_fraud_get_fraud_score_for_order_id($order->order_id)) {
    $greylist_lower_cap = variable_get('commerce_fraud_greylist_cap', 10);
    $greylist_upper_cap = variable_get('commerce_fraud_blacklist_cap', 20);

    return $fraud_score >= $greylist_lower_cap && $fraud_score < $greylist_upper_cap;
  }
  else {
    return FALSE;
  }
}

/**
 * Blacklist condition callback.
 */
function commerce_fraud_is_blacklisted($order) {
  if ($fraud_score = commerce_fraud_get_fraud_score_for_order_id($order->order_id)) {
    $blacklist_cap = variable_get('commerce_fraud_blacklist_cap', 20);

    return $fraud_score >= $blacklist_cap;
  }
  else {
    return FALSE;
  }
}

/**
 *
 */
function commerce_order_has_po_box($order) {
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
  $shipping_address = $order_wrapper->commerce_customer_shipping->commerce_customer_address;
  return preg_match("/(p(.*)?o(.*?)?)(\s+)?(bo?x)?(\s+)?[#]?(\d+)?/i", $shipping_address->thoroughfare->value());
}


/**
 * @return array
 */
function commerce_order_condition_fraud_level_operator_options() {
  return array(
    'commerce_fraud_is_whitelisted' => 'Whitelisted',
    'commerce_fraud_is_greylisted' => 'Greylisted',
    'commerce_fraud_is_blacklisted' => 'Blacklisted',
  );
}
